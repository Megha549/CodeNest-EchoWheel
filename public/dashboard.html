<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EchoWheel Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="wheelchair.png" type="image/png" />
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script type="module" src="qr.js"></script>
  <style>
    /* Fix for stop button layout shifting */
    #stopSoundBtn {
      visibility: hidden;
      width: 160px;
      height: 36px;
      margin-top: 10px;
    }

    #stopSoundBtn.visible {
      visibility: visible;
    }
  </style>
</head>

<body>
  <audio id="alertSound" src="alert.mp3" loop></audio>

  <div class="sidebar">
    <h2>ğŸ¦½ EchoWheel</h2>
    <nav>
      <ul>
        <li><a href="dashboard.html" class="active">Dashboard</a></li>
        <li><a href="patient-form.html">Patient Info</a></li>
        <li><a href="medication.html">Medication</a></li>
        <li><a href="logs.html">Emergency Logs</a></li>
        <li><a href="qr.html">QR Health ID</a></li>
        <li><a href="settings.html">Settings</a></li>
      </ul>
    </nav>
  </div>

  <main>
    <header>
      <div class="user-panel">
        <span>ğŸ‘¤ <span id="username">User</span></span> | <span>âš™ï¸ Settings</span>
        <button onclick="logout()" class="small-btn">ğŸšª Logout</button>
      </div>
    </header>

    <div class="grid-container">
      <section class="panel sensor">
        <h2>ğŸ“¡ Sensor Status</h2>
        <ul>
          <li>ğŸ› Speed: <span>1.8 m/s</span></li>
          <li>â†ªï¸ Tilt: <span>Left</span></li>
          <li>ğŸš§ Obstacle: <span>No</span></li>
          <li>ğŸš¨ Emergency: <span class="alert">Yes</span></li>
        </ul>
      </section>

      <section class="panel alert-gps">
        <button class="alert-btn" onclick="sendEmergencyAlert()">ğŸ”´ Play Emergency Alert</button>
        <button id="stopSoundBtn" class="small-btn">ğŸ”‡ Stop Alert Sound</button>

        <p class="status">âœ… Status: Waiting for alert...</p>

        <div class="gps-box">
          <h3>ğŸ§­ GPS Location</h3>
          <p id="location">ğŸ“ Fetching location...</p>
          <button class="small-btn" onclick="getLocation()">ğŸ”„ Refresh</button>
          <button class="small-btn" onclick="openMap()">ğŸ—ºï¸ View Map</button>
        </div>
      </section>

<section class="panel meds">
  <h2>ğŸ’Š Medication Tracker</h2>
  <ul>
    <li id="reminderContainer">â³ Loading...</li>
  </ul>
  <a href="medication.html" class="small-btn">â• Add Reminder</a>

  <button class="small-btn">ğŸ•’ History</button>
</section>


      <section class="panel health-qr">
        <h2>ğŸ†˜ QR Health ID</h2>
        <p>This helps emergency helpers scan & access patient's health info quickly.</p>
        <button class="small-btn" onclick="generateQR()">Generate Health QR</button>
        <button id="downloadQRBtn" class="small-btn" style="margin-top: 10px;">â¬‡ï¸ Download QR</button>

        <div id="qrcode" style="margin-top: 10px;"></div>
        <p style="margin-top: 10px;">â“ Missing patient info? <a href="patient-form.html">Fill here</a></p>
      </section>
    </div>

    <footer>
      <h3>ğŸ§¾ Recent Activity</h3>
      <ul>
        <li>[10:00 AM] ğŸš¨ Emergency alert sent</li>
        <li>[09:30 AM] ğŸ› Speed normal</li>
        <li>[09:00 AM] ğŸ’Š Reminder: Take medicine</li>
      </ul>
    </footer>
  </main>

  <script type="module">
  import { auth, db } from './js/firebase.js';
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  import {
    CollectionReference,
    query,
    where,
    orderBy,
    limit,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


  const reminderContainer = document.getElementById("dashboardReminder");
  let currentUser = null;
  let currentLat = null;
  let currentLon = null;

  // ğŸ” Auth check
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("username").textContent = user.email;
      getLocation();
    } else {
      alert("Please login first.");
      window.location.href = "login.html";
    }
  });

  // ğŸ”“ Logout function
  window.logout = function () {
    signOut(auth).then(() => {
      alert("Logged out");
      window.location.href = "login.html";
    });
  };

  // ğŸ“ Get Location
  window.getLocation = function () {
    const locationElement = document.getElementById("location");
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          currentLat = position.coords.latitude;
          currentLon = position.coords.longitude;
          locationElement.textContent = `ğŸ“ Lat: ${currentLat.toFixed(4)}, Lon: ${currentLon.toFixed(4)}`;
        },
        (error) => {
          console.error("Geolocation error:", error);
          locationElement.textContent = "âŒ Unable to fetch location.";
        }
      );
    } else {
      locationElement.textContent = "âŒ Geolocation not supported.";
    }
  };

  // ğŸ—ºï¸ Open map
  window.openMap = function () {
    if (currentLat && currentLon) {
      const url = `https://www.google.com/maps?q=${currentLat},${currentLon}`;
      window.open(url, "_blank");
    } else {
      alert("Please wait... location not fetched yet!");
    }
  };

  // ğŸš¨ Send emergency alert
  window.sendEmergencyAlert = async function () {
    if (!currentUser) return alert("User not logged in.");
    if (currentLat === null || currentLon === null) return alert("Location not available yet.");

    try {
      const docRef = await addDoc(collection(db, "emergency_alerts"), {
        userEmail: currentUser.email,
        timestamp: serverTimestamp(),
        location: {
          latitude: currentLat,
          longitude: currentLon,
        }
      });

      console.log("ğŸš¨ Alert logged with ID:", docRef.id);
      document.querySelector(".status").textContent = "âœ… Status: Alert Sent & Saved!";
      playAlertSound();

    } catch (e) {
      console.error("âŒ Error saving alert:", e);
      alert("Failed to save alert.");
    }
  };

  // ğŸ”Š Play alert sound
  function playAlertSound() {
    const sound = document.getElementById("alertSound");
    const stopBtn = document.getElementById("stopSoundBtn");

    sound.play().then(() => {
      stopBtn.classList.add("visible");
    }).catch(e => {
      console.warn("ğŸ”‡ Sound blocked:", e);
    });
  }

  // ğŸ”‡ Stop alert sound
  document.getElementById("stopSoundBtn").addEventListener("click", () => {
    const sound = document.getElementById("alertSound");
    const stopBtn = document.getElementById("stopSoundBtn");
    sound.pause();
    sound.currentTime = 0;
    stopBtn.classList.remove("visible");
  });

  // âœ… WhatsApp Alert Function
  window.sendWhatsAppAlert = async function () {
    if (!currentUser) {
      alert("User not logged in.");
      return;
    }

    try {
      const patientDoc = await getDoc(doc(db, "patient_info", currentUser.uid));
      if (!patientDoc.exists()) {
        alert("âŒ No patient info found.");
        return;
      }

      const data = patientDoc.data();
      const phone = data.emergencyContactNumber?.trim().replace(/\D/g, "");
      const name = data.name || "Patient";
      const bloodGroup = data.bloodGroup || "Unknown";

      if (!phone || phone.length < 10) {
        alert("âŒ Emergency contact number missing or invalid.");
        return;
      }

      const message = `ğŸš¨ *EMERGENCY ALERT* ğŸš¨\nName: ${name}\nBlood Group: ${bloodGroup}\nğŸ“ Location: https://maps.google.com/?q=${currentLat},${currentLon}`;
      const whatsappURL = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
      window.open(whatsappURL, "_blank");
    } catch (e) {
      console.error("Error sending WhatsApp alert:", e);
      alert("Something went wrong while sending WhatsApp alert.");
    }
  };
  function formatTime(timeString) {
  // Optional: add actual formatting if needed
  return timeString;
}

        // ğŸ’Š Fetch latest medication reminder
      try {
      const reminderContainer = document.getElementById("reminderContainer"); // make sure you have this element
      const reminderRef = collection(db, "reminders");
      const q = query(reminderRef, where("uid", "==", user.uid));
      const snapshot = await getDocs(q);

      if (!snapshot.empty) {
        const data = snapshot.docs[0].data();
        const formattedTime = formatTime(data.time);
        reminderContainer.innerHTML = `â° ${formattedTime} â€“ ${data.medName}`;
      } else {
        reminderContainer.innerHTML = "No upcoming reminders.";
      }
    } catch (e) {
      console.error("âŒ Error fetching reminder:", e);
      reminderContainer.innerHTML = "Failed to load reminder.";
    }

</script>
<button class="small-btn" onclick="sendWhatsAppAlert()">ğŸ“² WhatsApp Emergency</button>



</body>

</html>
